# Context
Filename: TushareTaskRefactoring.md
Created On: [Current DateTime]
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
Refactor TushareTask in `alphahome/fetchers/sources/tushare/tushare_task.py` by extracting its numerous helper methods into dedicated Helper Classes (e.g., TushareDataTransformer for data transformation/validation, TushareBatchProcessor for batch processing logic) to improve modularity and maintainability.

# Project Overview
AlphaHome an internal quantitative trading and research platform.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- `TushareTask` contains many helper methods for fetching, processing, transforming, validating, and saving data.
- Methods like `_process_single_batch`, `_fetch_raw_batch_with_retry`, `_transform_and_validate_batch_data`, `_save_validated_batch_data_with_retry` handle batch lifecycle.
- Methods like `_apply_column_mapping`, `_process_date_column`, `_sort_data`, `_apply_transformations`, `process_data`, `validate_data` handle data manipulation.
- Extracting these into separate classes will make `TushareTask` a cleaner orchestrator.

# Proposed Solution (Populated by INNOVATE mode)
Favored solution: Helper Class Extraction.
1.  **`TushareDataTransformer`**: This class will encapsulate methods responsible for data transformation, cleaning, and validation (e.g., `_apply_column_mapping`, `_process_date_column`, `_sort_data`, `_apply_transformations`, `process_data`, `validate_data`). It will take a `TushareTask` instance in its constructor to access task-specific configurations (like column mappings, date columns, schema, custom validation functions) and the logger.
2.  **`TushareBatchProcessor`**: This class will manage the lifecycle of a single data batch (e.g., `_fetch_raw_batch_with_retry`, `_transform_and_validate_batch_data` (which would call the transformer), `_save_validated_batch_data_with_retry`, and the main `_process_single_batch` orchestrator). It will take a `TushareTask` instance (for API calls, DB access, config) and a `TushareDataTransformer` instance in its constructor.

`TushareTask` will then instantiate these helper classes in its `__init__` and delegate calls to them. `TushareTask` itself will retain core orchestration logic, API interaction setup, and configuration management.

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
1. Create a new file: `alphahome/fetchers/sources/tushare/tushare_data_transformer.py`.
2. Define the `TushareDataTransformer` class in the new file. It should take a `TushareTask` instance in its `__init__`.
3. Migrate data transformation and validation methods from `TushareTask` to `TushareDataTransformer` (e.g., `_apply_column_mapping`, `_process_date_column`, `_sort_data`, `_apply_transformations`, `process_data`, `validate_data`). Adjust internal references (e.g., `self.column_mapping` to `self.task.column_mapping`).
4. Create a new file: `alphahome/fetchers/sources/tushare/tushare_batch_processor.py`.
5. Define the `TushareBatchProcessor` class in this new file. It should take `TushareTask` and `TushareDataTransformer` instances in its `__init__`.
6. Migrate batch processing methods from `TushareTask` to `TushareBatchProcessor` (e.g., `_fetch_raw_batch_with_retry`, `_transform_and_validate_batch_data`, `_save_validated_batch_data_with_retry`, `_process_single_batch`). Adjust calls: `_transform_and_validate_batch_data` will call methods on the `TushareDataTransformer` instance; `_fetch_raw_batch_with_retry` will call `self.task.fetch_batch`; `_save_validated_batch_data_with_retry` will call `self.task.db.upsert`.
7. Modify `alphahome/fetchers/sources/tushare/tushare_task.py`:
    *   Import the new `TushareDataTransformer` and `TushareBatchProcessor` classes.
    *   In the `__init__` method, instantiate these helper classes, passing `self` (and the transformer instance to the batch processor).
    *   Update the `execute` method (specifically the `process_batch_wrapper` or similar loop) to call the `process_single_batch` method on the `TushareBatchProcessor` instance instead of `self._process_single_batch`.
    *   Remove the original definitions of all migrated methods from `TushareTask` to avoid duplication and ensure the new classes are used.
    *   Review any other internal calls within `TushareTask` that might have been calling the now-migrated methods and update them to call the methods on the helper class instances if necessary (though most calls should originate from the batch processor now).
8. (Optional, but recommended) In `TushareTask`, if `process_data` or `validate_data` were `abc.abstractmethod` or just empty shells before, remove these declarations if they are no longer needed because their functionality is fully handled by `TushareDataTransformer`.
9. Carefully review import statements in all modified/created files to prevent circular dependencies (using `TYPE_CHECKING` for type hints if needed) and remove any unused imports.
10. Run static analysis tools (linter) to catch any immediate issues.
11. Final code review of the changes.

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "Checklist item 11: 最终代码审查。"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   [DateTime] 
    *   Step: 1. 创建新文件 `alphahome/fetchers/sources/tushare/tushare_data_transformer.py`。
    *   Modifications: Created `alphahome/fetchers/sources/tushare/tushare_data_transformer.py`.
    *   Change Summary: New empty file created for TushareDataTransformer class.
    *   Reason: Executing plan step 1.
    *   Blockers: None.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 2 & 3. 定义 `TushareDataTransformer` 类并将相关方法从 `TushareTask` 迁移至此。
    *   Modifications: Defined `TushareDataTransformer` in `alphahome/fetchers/sources/tushare/tushare_data_transformer.py` and populated it with methods (`_apply_column_mapping`, `_process_date_column`, `_sort_data`, `_apply_transformations`, `process_data`, `validate_data`) migrated from `TushareTask`, adjusting internal references to use `self.task`.
    *   Change Summary: Data transformation and validation logic moved to TushareDataTransformer.
    *   Reason: Executing plan steps 2 & 3.
    *   Blockers: Initial attempt had unicode escape issues, manually resolved by user, then linter fix attempt also had issues. User confirmed manual fix was okay.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 4. 创建新文件 `alphahome/fetchers/sources/tushare/tushare_batch_processor.py`。
    *   Modifications: Created `alphahome/fetchers/sources/tushare/tushare_batch_processor.py`.
    *   Change Summary: New empty file created for TushareBatchProcessor class.
    *   Reason: Executing plan step 4.
    *   Blockers: None.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 5 & 6. 定义 `TushareBatchProcessor` 类并将相关方法从 `TushareTask` 迁移至此。
    *   Modifications: Defined `TushareBatchProcessor` in `alphahome/fetchers/sources/tushare/tushare_batch_processor.py` and populated it with methods (`_fetch_raw_batch_with_retry`, `_transform_and_validate_batch_data`, `_save_validated_batch_data_with_retry`, `process_single_batch`) migrated or adapted from `TushareTask`, adjusting internal calls.
    *   Change Summary: Batch processing lifecycle logic moved to TushareBatchProcessor.
    *   Reason: Executing plan steps 5 & 6.
    *   Blockers: First edit attempt failed to write to file, second attempt succeeded.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 7. 修改 `alphahome/fetchers/sources/tushare/tushare_task.py` (导入、实例化、更新调用点、移除旧方法)。
    *   Modifications: 
        - Added imports for `TushareDataTransformer` and `TushareBatchProcessor`.
        - Instantiated helper classes in `__init__`.
        - Updated `execute` method to call `self.batch_processor.process_single_batch`.
        - Removed migrated methods (`_fetch_raw_batch_with_retry` through `validate_data`, including `_process_single_batch`).
    *   Change Summary: `TushareTask` now uses helper classes and has been significantly slimmed down.
    *   Reason: Executing plan step 7.
    *   Blockers: Initial edit attempts failed due to file mismatches after user's manual whitespace changes. Re-reading the file resolved this for subsequent edits. 
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 8. (可选) 移除 `TushareTask` 中未被引用的 `process_data` 和 `validate_data`。
    *   Modifications: Confirmed these methods were removed as part of step 7.
    *   Change Summary: No additional changes needed; methods already removed.
    *   Reason: Executing plan step 8.
    *   Blockers: None.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 9. 仔细检查所有相关文件中的导入语句。
    *   Modifications: Removed unused `Optional` from `typing` import in `alphahome/fetchers/sources/tushare/tushare_data_transformer.py`.
    *   Change Summary: Ensured imports are clean and correct.
    *   Reason: Executing plan step 9.
    *   Blockers: None.
    *   User Confirmation Status: Success
*   [DateTime]
    *   Step: 10. 运行代码静态分析工具。
    *   Modifications: User ran linter.
    *   Change Summary: Linter reported no issues.
    *   Reason: Executing plan step 10.
    *   Blockers: None.
    *   User Confirmation Status: Success

# Final Review (Populated by REVIEW mode)
Refactoring of `TushareTask` completed. Helper methods for data transformation/validation were extracted into `TushareDataTransformer`, and batch processing logic was extracted into `TushareBatchProcessor`. `TushareTask` now delegates these responsibilities to instances of these helper classes. Imports were updated, and migrated methods were removed from `TushareTask`. Linter checks passed. The implementation perfectly matches the refactoring plan. Comprehensive testing is recommended due to the structural changes. 