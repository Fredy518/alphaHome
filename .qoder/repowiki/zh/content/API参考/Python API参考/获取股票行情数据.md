# 获取股票行情数据

<cite>
**本文档引用的文件**  
- [data_access.py](file://alphahome/providers/data_access.py#L93-L162)
- [data_access.py](file://alphahome/providers/data_access.py#L500-L525)
- [db_manager.py](file://alphahome/common/db_manager.py#L90-L106)
- [database_operations_mixin.py](file://alphahome/common/db_components/database_operations_mixin.py#L315-L336)
- [utility_mixin.py](file://alphahome/common/db_components/utility_mixin.py#L175-L186)
- [usage_example.py](file://alphahome/providers/examples/usage_example.py#L31-L47)
</cite>

## 目录
1. [方法概述](#方法概述)
2. [参数详解](#参数详解)
3. [返回值说明](#返回值说明)
4. [使用示例](#使用示例)
5. [内部机制](#内部机制)
6. [常见问题与异常处理](#常见问题与异常处理)

## 方法概述

`get_stock_data` 是 `AlphaDataTool` 类的核心方法之一，用于从数据库中获取指定股票代码在给定时间范围内的日线行情数据。该方法设计简洁，遵循80/20原则，旨在满足绝大多数数据查询需求。

该方法通过参数化SQL查询从数据库中提取数据，确保了操作的安全性，并通过智能的表名检测机制增强了系统的容错能力。查询结果以 `pandas.DataFrame` 的形式返回，便于后续的数据分析和处理。

**Section sources**
- [data_access.py](file://alphahome/providers/data_access.py#L93-L162)

## 参数详解

`get_stock_data` 方法接受以下参数：

- **symbols**: 股票代码或代码列表。可以是单个股票代码（如 `'000001.SZ'`）或多个股票代码组成的列表（如 `['000001.SZ', '000002.SZ']`）。该参数会被标准化为列表格式进行处理。
- **start_date**: 查询的开始日期，格式为 `'YYYY-MM-DD'` 或 `datetime.date` 对象。
- **end_date**: 查询的结束日期，格式为 `'YYYY-MM-DD'` 或 `datetime.date` 对象。
- **fields**: 字段列表。此参数为保留参数，用于保持API的向后兼容性，但在当前实现中被忽略。方法会返回预定义的OHLCV等字段。
- **adjust**: 是否使用复权价格。此参数为兼容性保留，在当前数据库实现中不生效，方法返回的是原始价格数据。

**Section sources**
- [data_access.py](file://alphahome/providers/data_access.py#L93-L162)

## 返回值说明

该方法返回一个 `pandas.DataFrame` 对象，包含以下字段：

- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `pre_close`: 昨日收盘价
- `change`: 涨跌额
- `pct_chg`: 涨跌幅
- `vol`: 成交量
- `amount`: 成交额

数据类型转换和空值处理逻辑如下：
- `trade_date` 列会被转换为 `pandas.Timestamp` 类型。
- 所有数值列（如 `open`, `high`, `low`, `close`, `vol`, `amount` 等）都会通过 `pd.to_numeric(..., errors='coerce')` 进行转换，任何无法转换的值将被设置为 `NaN`（空值）。

如果查询结果为空，方法会返回一个空的 `DataFrame` 并记录警告日志。

**Section sources**
- [data_access.py](file://alphahome/providers/data_access.py#L150-L156)

## 使用示例

要使用 `get_stock_data` 方法，首先需要创建一个 `AlphaDataTool` 实例，然后调用该方法。

```python
from alphahome.providers import AlphaDataTool
from alphahome.common.db_manager import create_sync_manager

# 1. 创建数据库管理器（同步模式）
connection_string = "postgresql://user:password@localhost:5432/alphahome"
db_manager = create_sync_manager(connection_string)

# 2. 初始化 AlphaDataTool
data_tool = AlphaDataTool(db_manager)

# 3. 调用 get_stock_data 方法获取单只股票数据
single_stock_df = data_tool.get_stock_data(
    symbols='000001.SZ',
    start_date='2024-01-01',
    end_date='2024-01-31'
)

# 4. 调用 get_stock_data 方法获取多只股票数据
multi_stock_df = data_tool.get_stock_data(
    symbols=['000001.SZ', '000002.SZ'],
    start_date='2024-01-01',
    end_date='2024-01-31'
)
```

**Section sources**
- [usage_example.py](file://alphahome/providers/examples/usage_example.py#L31-L47)

## 内部机制

`get_stock_data` 方法的内部实现依赖于一个私有方法 `_get_stock_table`，该方法实现了智能的表名检测和容错机制。

1.  **表名检测 (`_get_stock_table`)**:
    *   该方法会检查一个预定义的候选表名列表（如 `['tushare.stock_daily']`）。
    *   它会尝试对每个候选表名执行一个简单的测试查询（`SELECT 1 FROM {table} LIMIT 1`）。
    *   如果查询成功，则认为该表存在，并将其作为当前会话的缓存表名返回。
    *   如果所有候选表都不存在，则使用默认表名 `tushare.stock_daily` 并发出警告。

2.  **数据库查询**:
    *   一旦确定了表名，方法会构建一个参数化的SQL查询语句。
    *   查询使用 `self.db_manager.fetch_sync` 方法执行，该方法是 `DBManager` 类提供的同步查询接口。
    *   `DBManager` 根据其初始化模式（同步或异步）选择使用 `psycopg2` 或 `asyncpg` 来执行查询。

3.  **连接管理**:
    *   `DBManager` 负责管理数据库连接。在同步模式下，它使用 `psycopg2` 并通过线程本地存储确保线程安全。
    *   连接状态可以通过 `AlphaDataTool` 的 `is_connected` 属性进行检查，该属性内部调用了 `DBManager` 的 `test_connection` 方法。

```mermaid
flowchart TD
A[调用 get_stock_data] --> B[标准化 symbols 参数]
B --> C[调用 _get_stock_table]
C --> D{表名缓存中存在?}
D -- 是 --> E[返回缓存表名]
D -- 否 --> F[遍历候选表名]
F --> G{测试查询成功?}
G -- 是 --> H[缓存并返回表名]
G -- 否 --> F
H --> I[构建参数化SQL查询]
I --> J[调用 db_manager.fetch_sync]
J --> K[执行数据库查询]
K --> L[处理查询结果]
L --> M[数据类型转换]
M --> N[返回 DataFrame]
```

**Diagram sources **
- [data_access.py](file://alphahome/providers/data_access.py#L122-L143)
- [data_access.py](file://alphahome/providers/data_access.py#L500-L525)
- [database_operations_mixin.py](file://alphahome/common/db_components/database_operations_mixin.py#L315-L336)
- [db_manager.py](file://alphahome/common/db_manager.py#L90-L106)

**Section sources**
- [data_access.py](file://alphahome/providers/data_access.py#L122-L143)
- [data_access.py](file://alphahome/providers/data_access.py#L500-L525)

## 常见问题与异常处理

在使用 `get_stock_data` 方法时，可能会遇到以下问题：

- **数据库连接失败**: 如果 `DBManager` 无法连接到数据库，`fetch_sync` 方法会抛出异常。`get_stock_data` 会捕获此异常，记录错误日志，并抛出一个 `DataAccessError` 异常。
- **查询结果为空**: 如果在指定的时间范围内没有找到任何数据，方法会返回一个空的 `DataFrame`，并在日志中记录一条警告信息。
- **SQL执行错误**: 任何在SQL执行过程中发生的错误（如语法错误、权限问题等）都会被捕获，记录错误日志，并最终抛出 `DataAccessError`。

所有异常都通过统一的 `DataAccessError` 类抛出，便于上层应用进行集中处理。

**Section sources**
- [data_access.py](file://alphahome/providers/data_access.py#L160-L162)
- [utility_mixin.py](file://alphahome/common/db_components/utility_mixin.py#L175-L186)