# 附录

<cite>
**本文档引用的文件**   
- [config.example.json](file://config.example.json)
- [constants.py](file://alphahome/common/constants.py)
- [data_sources.md](file://docs/business/data_sources.md)
- [configuration.md](file://docs/setup/configuration.md)
- [tushare_stock_ahcomparison.md](file://docs/tasks/tushare_stock_ahcomparison.md)
- [tushare_stock_limitprice.md](file://docs/tasks/tushare_stock_limitprice.md)
- [tushare_stock_st.md](file://docs/tasks/tushare_stock_st.md)
- [tushare_macro_cnm.md](file://docs/tasks/tushare_macro_cnm.md)
- [pit_incremental_update_guide.md](file://docs/pit_incremental_update_guide.md)
- [pit_materialized_view_plan.md](file://docs/development/pit_materialized_view_plan.md)
- [requirements.md](file://docs/processors/requirements.md)
- [design.md](file://docs/processors/design.md)
</cite>

## 目录
1. [配置文件参数说明](#配置文件参数说明)
2. [支持的数据源与API配额](#支持的数据源与api配额)
3. [术语表](#术语表)
4. [任务文档链接与处理器需求摘要](#任务文档链接与处理器需求摘要)

## 配置文件参数说明

本节详细说明项目中所有配置文件的参数，主要基于 `config.example.json` 和 `constants.py` 文件。

### 数据库配置

数据库配置位于 `config.example.json` 的 `database` 节点下，用于定义与 PostgreSQL 数据库的连接和性能优化参数。

**参数说明：**
- `url`: 数据库连接字符串，格式为 `postgresql://用户名:密码@主机:端口/数据库名`。
- `pool_config`: 数据库连接池配置，用于优化批量数据操作性能。
  - `min_size`: 连接池最小连接数，默认为 5。
  - `max_size`: 连接池最大连接数，默认为 25。
  - `command_timeout`: 命令超时时间（秒），默认为 180 秒。
  - `max_queries`: 单个连接最大查询数，用于连接回收。
  - `max_inactive_connection_lifetime`: 连接最大非活动生存时间（秒），默认为 300 秒。
  - `server_settings`: PostgreSQL 服务器设置，用于优化连接性能。
    - `application_name`: 应用程序名称，用于数据库监控。
    - `tcp_keepalives_idle`: TCP 保活空闲时间（秒）。
    - `tcp_keepalives_interval`: TCP 保活间隔时间（秒）。
    - `tcp_keepalives_count`: TCP 保活探测次数。
    - `jit`: 是否启用即时编译（JIT），建议关闭以提升性能。

**Section sources**
- [config.example.json](file://config.example.json#L3-L19)

### API配置

API 配置位于 `config.example.json` 的 `api` 节点下，用于定义外部数据源的访问凭证。

**参数说明：**
- `tushare_token`: Tushare Pro API 的访问令牌，是访问金融数据的核心凭证。
- `ifind`: iFind 数据源的配置。
  - `base_url`: iFind API 的基础 URL。
  - `refresh_token`: iFind 的刷新令牌，用于维持长期访问。

**Section sources**
- [config.example.json](file://config.example.json#L22-L27)

### 性能监控配置

性能监控配置位于 `config.example.json` 的 `performance` 节点下，用于控制系统的监控和优化行为。

**参数说明：**
- `enable_monitoring`: 是否启用性能监控，默认为 `true`。
- `max_history_records`: 性能历史记录的最大条数。
- `log_slow_operations`: 是否记录慢操作日志。
- `slow_operation_threshold`: 慢操作阈值（秒），超过此时间的操作将被记录。
- `auto_batch_size_optimization`: 是否自动优化批处理大小。

**Section sources**
- [config.example.json](file://config.example.json#L29-L35)

### 任务特定配置

任务特定配置位于 `config.example.json` 的 `tasks` 节点下，允许为特定数据抓取任务覆盖全局默认设置。

**参数说明：**
- `save_batch_size`: 数据保存批次大小，即每次批量写入数据库的行数。例如，`tushare_stock_daily` 设置为 5000。
- `concurrent_limit`: 任务的并发限制，控制同时执行的请求数量。例如，`tushare_stock_daily` 设置为 10。
- `max_retries`: 最大重试次数，用于处理网络或 API 临时错误。
- `retry_delay`: 重试延迟时间（秒），避免过于频繁的重试。
- `update_frequency`: 更新频率，如 `tushare_stock_basic` 设置为 `daily`。

**Section sources**
- [config.example.json](file://config.example.json#L37-L51)

### 回测配置

回测配置位于 `config.example.json` 的 `backtesting` 节点下，为回测引擎提供默认参数。

**参数说明：**
- `default_cash`: 回测初始资金。
- `default_commission`: 交易佣金费率。
- `cache_data`: 是否缓存回测数据以提升性能。
- `max_cache_size`: 最大缓存大小。
- `default_start_date`: 回测默认开始日期。
- `default_end_date`: 回测默认结束日期。
- `default_table`: 回测默认使用的数据表。

**Section sources**
- [config.example.json](file://config.example.json#L53-L61)

### 常量定义

`constants.py` 文件定义了项目中使用的常量，确保代码的一致性和可维护性。

**常量说明：**
- `UpdateTypes`: 定义任务更新类型的常量。
  - `SMART`: 智能增量更新模式。
  - `MANUAL`: 手动增量更新模式。
  - `FULL`: 全量更新模式。
  - `SMART_DISPLAY`: "智能增量" 的显示文本。
  - `MANUAL_DISPLAY`: "手动增量" 的显示文本。
  - `FULL_DISPLAY`: "全量更新" 的显示文本。
- `ApiParams`: 定义 API 参数的常量。
  - `LIST_STATUS_LISTED`: 上市状态，值为 `"L"`。
  - `LIST_STATUS_DELISTED`: 退市状态，值为 `"D"`。
  - `LIST_STATUS_PAUSED`: 暂停上市状态，值为 `"P"`。

**Section sources**
- [constants.py](file://alphahome/common/constants.py#L3-L23)

## 支持的数据源与API配额

本节列出项目支持的主要数据源及其API的使用限制与配额。

### Tushare Pro

Tushare Pro 是项目最主要的金融数据源，提供股票、基金、指数、财务等各类数据。

**API配额与限制：**
- **通用限制**:
  - 大部分接口支持按 `trade_date` 或 `end_date` 进行增量查询。
  - 接口调用频率受用户等级限制，需在配置中合理设置 `rate_limit_delay`。
- **特定接口限制**:
  - `daily` (股票日线): 单次请求最多返回 5000 条记录，建议使用交易日批量策略。
  - `stock_basic` (股票基础信息): 全量替换更新，无严格单次限制。
  - `fina_indicator` (财务指标): 单次请求最多返回 5000 条记录，需分批处理。
  - `fund_daily` (基金日线): 单次请求最多返回 5000 条记录。
  - `stk_ah_comparison` (AH股比价): 单次最多返回 1000 条记录，数据自 2025-08-12 起提供。
  - `stk_limit` (涨跌停价格): 单次最多返回 5800 条记录，建议限制为 5000 条以保证安全。
  - `stock_st` (ST股票列表): 单次最多返回 1000 条记录。
  - `cn_m` (货币供应量): 单次最多返回 5000 条记录，数据总量小，通常一次全量获取。

**Section sources**
- [data_sources.md](file://docs/business/data_sources.md)
- [tushare_stock_ahcomparison.md](file://docs/tasks/tushare_stock_ahcomparison.md)
- [tushare_stock_limitprice.md](file://docs/tasks/tushare_stock_limitprice.md)
- [tushare_stock_st.md](file://docs/tasks/tushare_stock_st.md)
- [tushare_macro_cnm.md](file://docs/tasks/tushare_macro_cnm.md)

### iFind

iFind 是另一个金融数据源，通过其 API 提供数据。

**API配额与限制：**
- 使用 `refresh_token` 进行身份验证。
- 具体的 API 限制和配额需参考 iFind 官方文档，项目中通过 `ifind_api.py` 进行封装和调用。

**Section sources**
- [config.example.json](file://config.example.json#L24-L27)

## 术语表

本节解释项目中使用的专业术语。

### PIT (Point-in-Time)

PIT 指“特定时间点”，是一种数据处理方法。它将历史财务数据（如季度报告）与每日交易数据对齐，使得在任意历史交易日都能查询到当时可用的最新财务信息。例如，在 2024 年 6 月 30 日，查询某公司的净资产收益率（ROE）时，PIT 系统会返回截至该日已公告的最新季度报告中的 ROE 值，而不是当前最新的报告。这确保了回测和研究的准确性，避免了“未来函数”问题。

**Section sources**
- [pit_incremental_update_guide.md](file://docs/pit_incremental_update_guide.md)
- [pit_materialized_view_plan.md](file://docs/development/pit_materialized_view_plan.md)

### 物化视图 (Materialized View)

物化视图是数据库中一种将复杂查询结果预先计算并存储起来的机制。与普通视图（每次查询都重新计算）不同，物化视图的数据是物理存储的，因此查询速度极快。在本项目中，物化视图被用于优化 PIT 数据的查询性能。通过将复杂的 PIT 时间序列展开逻辑（如 `query_start_date` 和 `query_end_date` 的计算）预计算并存储，可以将查询响应时间从数百毫秒降低到几毫秒，提升数十倍。

**Section sources**
- [pit_materialized_view_plan.md](file://docs/development/pit_materialized_view_plan.md)

### 智能更新 (Smart Update)

智能更新是一种高效的数据更新策略。它通过分析数据源的更新规律（如 Tushare 数据通常在交易日的特定时间后更新），结合一个“回溯天数”（`smart_lookback_days`），只查询最近几天可能发生变化的数据，从而避免了全量扫描，大幅提升了更新效率。例如，`smart_lookback_days=3` 表示每次更新时只检查过去 3 天的数据是否有新增或变更。

**Section sources**
- [constants.py](file://alphahome/common/constants.py#L7)
- [tushare_stock_ahcomparison.md](file://docs/tasks/tushare_stock_ahcomparison.md#L18)
- [tushare_stock_limitprice.md](file://docs/tasks/tushare_stock_limitprice.md#L17)

## 任务文档链接与处理器需求摘要

本节提供特定任务的详细说明文档链接和处理器模块的需求文档摘要。

### 任务文档链接

以下链接指向特定数据抓取任务的详细开发文档，包含任务背景、分析、实施方案和计划。

- [tushare_stock_ahcomparison.md](file://docs/tasks/tushare_stock_ahcomparison.md): AH股比价数据抓取任务文档。
- [tushare_stock_limitprice.md](file://docs/tasks/tushare_stock_limitprice.md): 涨跌停价格数据抓取任务文档。
- [tushare_stock_st.md](file://docs/tasks/tushare_stock_st.md): ST股票列表数据抓取任务文档。
- [tushare_macro_cnm.md](file://docs/tasks/tushare_macro_cnm.md): 货币供应量数据抓取任务文档。

### 处理器模块需求摘要

处理器模块（`processors`）旨在对原始数据进行清洗、标准化和处理，为上层研究和特征计算提供高质量、可信赖的数据输入。

**核心目标：**
- **分层规范**：明确“处理层”（clean）与“特征层”（feature）的边界。处理层负责数据清洗、对齐、标准化和幂等入库；特征层负责在处理层数据上进行滚动计算、分位数等复杂特征生成。
- **高质量输入**：处理层输出的数据应是经过校验、对齐、单位统一（如金额统一为“元”）和复权标准化的“干净”数据。
- **血缘记录**：处理过程需记录数据血缘，便于追踪和审计。
- **破坏性变更**：由于处理层尚未正式使用，允许进行破坏性变更以实现最佳设计。

**成功标准：**
- 清晰的分层边界与接口契约。
- 现有任务有明确的分类与后续拆分指引。
- 特征入库有明确的白名单与判定标准（如高复用、重算成本高的基础因子可入库）。

**Section sources**
- [requirements.md](file://docs/processors/requirements.md)
- [design.md](file://docs/processors/design.md)