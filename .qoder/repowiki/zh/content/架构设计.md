# 架构设计

<cite>
**Referenced Files in This Document**   
- [base_task.py](file://alphahome/common/task_system/base_task.py)
- [task_factory.py](file://alphahome/common/task_system/task_factory.py)
- [task_decorator.py](file://alphahome/common/task_system/task_decorator.py)
- [db_manager.py](file://alphahome/common/db_manager.py)
- [db_manager_core.py](file://alphahome/common/db_components/db_manager_core.py)
- [database_operations_mixin.py](file://alphahome/common/db_components/database_operations_mixin.py)
- [schema_management_mixin.py](file://alphahome/common/db_components/schema_management_mixin.py)
- [utility_mixin.py](file://alphahome/common/db_components/utility_mixin.py)
- [config_manager.py](file://alphahome/common/config_manager.py)
- [logging_utils.py](file://alphahome/common/logging_utils.py)
- [processor_task_base.py](file://alphahome/processors/tasks/base_task.py)
- [tushare_task.py](file://alphahome/fetchers/sources/tushare/tushare_task.py)
</cite>

## 目录
1. [系统架构概览](#系统架构概览)
2. [任务系统设计](#任务系统设计)
3. [分层架构](#分层架构)
4. [基础设施设计](#基础设施设计)
5. [组件交互图](#组件交互图)
6. [数据流图](#数据流图)

## 系统架构概览

本系统采用模块化、分层的架构设计，旨在实现高内聚、低耦合的软件结构。系统核心围绕任务系统（Task System）展开，通过模板方法模式定义了标准化的任务执行流程。整体架构分为四个主要层次：任务层、数据层、基础设施层和应用层。

系统采用异步编程模型，利用`asyncio`实现高并发的数据采集和处理。数据库访问通过`asyncpg`（异步）和`psycopg2`（同步）双模式支持，满足不同场景的需求。代码组织遵循清晰的目录结构，将功能模块（如`fetchers`、`processors`）与通用组件（如`common`）分离，提高了代码的可维护性和可扩展性。

```mermaid
graph TD
subgraph "应用层"
GUI[GUI应用]
CLI[命令行接口]
end
subgraph "任务层"
TaskSystem[任务系统]
TaskFactory[任务工厂]
TaskDecorator[任务装饰器]
end
subgraph "数据层"
Fetchers[数据采集器]
Processors[数据处理器]
DataLayer[数据层]
end
subgraph "基础设施层"
DBManager[数据库管理器]
ConfigManager[配置管理器]
LogManager[日志管理器]
end
GUI --> TaskSystem
CLI --> TaskSystem
TaskSystem --> Fetchers
TaskSystem --> Processors
TaskSystem --> DBManager
TaskSystem --> ConfigManager
TaskSystem --> LogManager
DataLayer --> DBManager
**Diagram sources**
- [main.py](file://run.py)
- [project_structure](file://README.md)
**Section sources**
- [run.py](file://run.py)
- [README.md](file://README.md)
## 任务系统设计
任务系统是本项目的核心，其设计基于模板方法模式Template Method Pattern，在`base_task.py`文件中的`BaseTask`类中实现。该模式定义了一个不可变的算法骨架`execute`方法，而将具体的步骤实现延迟到子类中。
### 模板方法模式与执行流程
`BaseTask`类的`execute`方法定义了标准的四步执行流程：`fetch -> process -> validate -> save`。这个流程是一个`final`方法，子类不应重写它，而是通过实现特定的钩子方法来定制行为。
```mermaid
sequenceDiagram
    participant Client as "客户端"
    participant BaseTask as "BaseTask"
    participant Hook as "钩子方法"

    Client->>BaseTask: execute()
    BaseTask->>Hook: _fetch_data()
    Hook-->>BaseTask: 原始数据
    BaseTask->>Hook: process_data()
    Hook-->>BaseTask: 处理后数据
    BaseTask->>Hook: _validate_data()
    Hook-->>BaseTask: 验证结果
    BaseTask->>Hook: _save_data()
    Hook-->>BaseTask: 保存结果
    BaseTask-->>Client: 执行结果

    **Diagram sources**
    - [base_task.py](file://alphahome/common/task_system/base_task.py#L138-L238)

**Section sources**
- [base_task.py](file://alphahome/common/task_system/base_task.py#L138-L238)

#### 执行流程详解

1.  **获取数据 (`_fetch_data`)**: 这是一个抽象方法，由子类实现。它负责从外部数据源（如API、数据库）获取原始数据。对于数据采集任务（Fetcher），这通常涉及网络请求；对于数据处理任务（Processor），这可能涉及从数据库查询多个源表。

2.  **处理数据 (`process_data`)**: 这是一个可重写的方法，用于对获取的原始数据进行处理。默认实现会调用`_apply_transformations`来应用基础的数据转换（如类型转换、列名映射）。子类可以重写此方法，添加特定的业务逻辑，如数据清洗、特征计算等。

3.  **验证数据 (`_validate_data`)**: 这是一个统一的数据验证入口点。它会遍历任务定义的`validations`列表，执行一系列验证规则。支持两种模式：`report`（报告模式，记录结果但不修改数据）和`filter`（过滤模式，移除不符合规则的数据行）。

4.  **保存数据 (`_save_data`)**: 负责将处理并验证后的数据持久化到数据库。它会先确保目标表存在（通过`_ensure_table_exists`），然后调用`_save_to_database`进行实际的保存操作。保存策略支持`INSERT`（直接插入）和`UPSERT`（智能更新，基于主键冲突检测）。

### 任务注册与工厂模式

系统使用工厂模式来管理任务的创建和生命周期。`task_factory.py`中的`UnifiedTaskFactory`类是核心的工厂实现，它负责：

*   **注册任务**: 通过`register_task`方法将任务类注册到工厂的注册表中。
*   **初始化**: 建立数据库连接，并将连接注入到所有任务实例中。
*   **创建实例**: 提供`get_task`和`create_task_instance`等方法，根据任务名称创建或获取任务实例。

任务的注册通过装饰器`task_register`（在`task_decorator.py`中定义）实现，这是一种便捷的注册方式。当一个任务类被`@task_register`装饰时，它会自动被注册到`UnifiedTaskFactory`中。

```mermaid
classDiagram
class UnifiedTaskFactory {
+register_task(task_name, task_class)
+initialize(db_url)
+get_task(task_name)
+create_task_instance(task_name, **kwargs)
}
class BaseTask {
<<Abstract>>
+execute()
#_fetch_data()
#process_data()
#_validate_data()
#_save_data()
}
class FetcherTask {
<<Abstract>>
#_fetch_data()
#get_batch_list()
#prepare_params()
#fetch_batch()
}
class TushareTask {
<<Abstract>>
#prepare_params()
#fetch_batch()
}
class TushareStockDailyTask {
#get_batch_list()
}
UnifiedTaskFactory --> BaseTask : "管理"
BaseTask <|-- FetcherTask
FetcherTask <|-- TushareTask
TushareTask <|-- TushareStockDailyTask
**Diagram sources**
- [task_factory.py](file : //alphahome/common/task_system/task_factory.py)
- [base_task.py](file : //alphahome/common/task_system/base_task.py)
- [tushare_task.py](file : //alphahome/fetchers/sources/tushare/tushare_task.py)
**Section sources**
- [task_factory.py](file : //alphahome/common/task_system/task_factory.py)
- [task_decorator.py](file : //alphahome/common/task_system/task_decorator.py)
- [base_task.py](file : //alphahome/common/task_system/base_task.py)
## 分层架构
系统采用了清晰的分层架构，包括数据分层和代码模块分层，以提高数据质量和代码的可维护性。
### 数据分层
数据分层遵循`fetch -> clean -> feature -> save`的流程，确保数据在不同处理阶段的清晰性和可追溯性。
* **原始层 (Raw Layer)** : 由`fetchers`模块的任务直接从外部API获取的数据，存储在`rawdata` schema中。这一层的数据是原始的、未经处理的。
* **清洗层 (Clean Layer)** : 由`processors`模块的任务处理，通过`ProcessorTaskBase`类的`clean_data`方法实现。该方法组合了`DataValidator`、`DataAligner`、`DataStandardizer`等组件，对数据进行校验、对齐和标准化，确保数据质量。
* **特征层 (Feature Layer)** : 在清洗后的数据基础上，通过`compute_features`方法计算衍生指标和特征。这一层的数据用于支持高级分析和研究。
### 代码模块分层
代码的模块化设计体现了分层思想：
* **`fetchers` 模块** : 负责数据采集，包含针对不同数据源如`tushare`, `akshare`的具体实现。每个采集器都继承自`FetcherTask`，实现了特定的批处理逻辑。
* **`processors` 模块** : 负责数据处理和特征计算。`ProcessorTaskBase`类定义了处理任务的基类，编排了从数据获取到结果保存的完整流程。
* **`common` 模块** : 包含跨模块共享的通用组件，如任务系统、数据库管理器、配置管理器等，是整个系统的基础。
这种分层设计的优势在于：
* **职责分离** : 每一层都有明确的职责，降低了模块间的耦合度。
* **可维护性** : 可以独立地修改或替换某一层的实现，而不会影响其他层。
* **可追溯性** : 数据从原始到最终形态的转换过程清晰可见，便于调试和审计。
```mermaid
flowchart TD
    A[数据采集] --> B[原始数据]
    B --> C[数据清洗]
    C --> D[清洗后数据]
    D --> E[特征计算]
    E --> F[特征数据]
    F --> G[数据存储]

    **Diagram sources**
    - [processor_task_base.py](file://alphahome/processors/tasks/base_task.py#L494-L510)

**Section sources**
- [processor_task_base.py](file://alphahome/processors/tasks/base_task.py)

## 基础设施设计

系统的基础设施为上层应用提供了稳定可靠的支持，主要包括数据库管理、配置管理和日志系统。

### 数据库管理

数据库管理器（`DBManager`）是系统与数据库交互的核心。它采用多重继承的架构，整合了多个功能组件：

*   **`DBManagerCore`**: 核心连接管理，支持`async`（异步）和`sync`（同步）两种工作模式。异步模式使用`asyncpg`连接池，适用于高并发的数据采集；同步模式使用`psycopg2`，兼容Backtrader等同步框架。
*   **`DatabaseOperationsMixin`**: 提供高级数据操作，如`copy_from_dataframe`（利用PostgreSQL的COPY命令实现高速数据导入）和`upsert`（智能更新）。该组件还内置了性能监控功能，能动态建议最优的批次大小。
*   **`SchemaManagementMixin`**: 负责表结构管理，能根据任务的`schema_def`自动创建表、索引和视图。它还实现了`rawdata` schema的自动映射，将不同数据源（如`tushare`, `akshare`）的表统一映射到`rawdata`下，方便用户查询。
*   **`UtilityMixin`**: 提供实用工具，如`get_latest_date`（获取表的最新日期）、`test_connection`（测试连接）等。

```mermaid
classDiagram
class DBManager {
<<Class>>
}
class DBManagerCore {
<<Component>>
+connect()
+close()
}
class DatabaseOperationsMixin {
<<Component>>
+copy_from_dataframe()
+upsert()
+get_performance_statistics()
}
class SchemaManagementMixin {
<<Component>>
+create_table_from_schema()
+create_rawdata_view()
}
class UtilityMixin {
<<Component>>
+get_latest_date()
+test_connection()
}
DBManager --|> DBManagerCore
DBManager --|> DatabaseOperationsMixin
DBManager --|> SchemaManagementMixin
DBManager --|> UtilityMixin
**Diagram sources**
- [db_manager.py](file : //alphahome/common/db_manager.py)
- [db_manager_core.py](file : //alphahome/common/db_components/db_manager_core.py)
- [database_operations_mixin.py](file : //alphahome/common/db_components/database_operations_mixin.py)
- [schema_management_mixin.py](file : //alphahome/common/db_components/schema_management_mixin.py)
- [utility_mixin.py](file : //alphahome/common/db_components/utility_mixin.py)
**Section sources**
- [db_manager.py](file : //alphahome/common/db_manager.py)
- [db_manager_core.py](file : //alphahome/common/db_components/db_manager_core.py)
### 配置管理
`config_manager.py`实现了配置管理器，采用单例模式，确保全局配置的一致性。它支持多级配置来源：
1. **配置文件** : 优先从用户主目录下的`~/.alphahome/config.json`加载。
2. **环境变量** : 如果配置文件中未设置，则尝试从环境变量如`DATABASE_URL`, `TUSHARE_TOKEN`读取。
3. **默认值** : 作为最后的回退。
这种设计使得系统既可以在开发环境中通过配置文件灵活配置，也可以在生产环境中通过环境变量进行安全部署。
### 日志系统
`logging_utils.py`提供了统一的日志管理工具。它封装了`logging`模块，提供了`setup_logging`和`get_logger`等便捷函数。所有模块都应通过`get_logger(__name__)`获取logger，确保日志来源清晰。日志系统支持输出到控制台和文件，并且是线程安全的。
**Section sources**
- [config_manager.py](file : //alphahome/common/config_manager.py)
- [logging_utils.py](file : //alphahome/common/logging_utils.py)
## 组件交互图
下图展示了系统主要组件之间的交互关系。
```mermaid
graph TD
    A[GUI/CLI] --> B[TaskFactory]
    B --> C[BaseTask]
    C --> D[FetcherTask]
    C --> E[ProcessorTaskBase]
    D --> F[TushareTask]
    F --> G[TushareStockDailyTask]
    E --> H[CustomProcessorTask]
    C --> I[DBManager]
    I --> J[DBManagerCore]
    I --> K[DatabaseOperationsMixin]
    I --> L[SchemaManagementMixin]
    I --> M[UtilityMixin]
    C --> N[ConfigManager]
    C --> O[Logger]

    **Diagram sources**
    - [task_factory.py](file://alphahome/common/task_system/task_factory.py)
    - [base_task.py](file://alphahome/common/task_system/base_task.py)
    - [db_manager.py](file://alphahome/common/db_manager.py)
    - [config_manager.py](file://alphahome/common/config_manager.py)
    - [logging_utils.py](file://alphahome/common/logging_utils.py)

**Section sources**
- [run.py](file://run.py)
- [main_window.py](file://alphahome/gui/main_window.py)

## 数据流图

下图描述了数据在一个典型任务（如`TushareStockDailyTask`）中的流动过程。

```mermaid
flowchart LR
    A[外部API] -->|HTTP请求| B[FetcherTask]
    B -->|原始数据| C[process_data]
    C -->|处理后数据| D[_validate_data]
    D -->|验证结果| E[_save_data]
    E -->|数据| F[数据库]
    F -->|CREATE VIEW| G[rawdata schema]
    G --> H[用户查询]

    **Diagram sources**
    - [base_task.py](file://alphahome/common/task_system/base_task.py)
    - [tushare_task.py](file://alphahome/fetchers/sources/tushare/tushare_task.py)

**Section sources**
- [base_task.py](file://alphahome/common/task_system/base_task.py)
- [tushare_task.py](file://alphahome/fetchers/sources/tushare/tushare_task.py)