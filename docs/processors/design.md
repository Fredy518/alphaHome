#!/usr/bin/env markdown

# processors 分层设计文档（Draft）

## 分层规范
- 处理层（clean schema）
  - 职责：校验（类型/缺失/异常/重复）、对齐（trade_date、ts_code/标的）、单位/币种/复权标准化、血缘、幂等入库。
  - 输出：表在 `clean` schema；主键推荐 `trade_date + ts_code`（或按业务调整），时间列统一为 `trade_date`（yyyyMMdd 或 datetime），金额单位统一（元），复权口径明确。
- 特征层
  - 职责：在 clean 数据上计算特征；保持纯函数；窗口/分位/去极值参数可配置。
  - 存储策略：高复用、重算成本高、线上/风控常用的基础因子可入库；低复用或策略特定特征不入库，可现算或缓存。
- 任务层
  - 职责：编排数据流，不内嵌特征实现；调用 features/operations 组合。

## 命名与主键
- schema：`clean`
- 标的列：保持 `ts_code`（与源一致）；如需对外暴露 `symbol`，可在特征层/API 层提供映射或视图。
- 时间列：`trade_date`
- 量纲：统一单位（元/手/股等），明确复权口径。

## 特征入库判定标准
- 入库：高复用、重算成本高、线上或风控直接查询的基础因子（估值分位/ERP、波动分位与比值、IV 期限结构关键点、资金流/宽度/基差分位）。
- 不入库：策略特定组合打分、低复用、低成本特征。

## 测试策略
- 处理层：脏数据/缺列/错类型/重复索引/零或负值防御；幂等写入；血缘字段校验。
- 特征层：性质测试（NaN 保留、除零安全、窗口边界、分位单调性、去极值幂等）。
- 任务层：编排与列存在性、小规模集成。

## 迁移与破坏性变更（规划）
- 建立 clean schema；定义表结构/主键/单位。
- 拆特征：将滚动/分位/插值等下沉到 features/operations；任务仅调用。
- 表迁移/回填：如需重命名或迁移，使用视图或一次性迁移（允许破坏性变更）。

## 开放问题
- 特征入库的更新/回填机制与调度策略。
- 血缘元数据的存储方式（表内字段 vs 侧表）。

