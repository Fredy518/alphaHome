# rawdata Schema è‡ªåŠ¨è§†å›¾æ˜ å°„ç³»ç»Ÿ - é¡¹ç›®å®Œæˆæ€»ç»“

## ğŸ“Œ é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®Œæˆäº† **rawdata schema è‡ªåŠ¨è§†å›¾æ˜ å°„ç³»ç»Ÿ**çš„å®Œæ•´å®æ–½ï¼Œå®ç°äº†ä¸åŒæ•°æ®æºï¼ˆtushareã€akshareç­‰ï¼‰åˆ°ç»Ÿä¸€ rawdata schema çš„è‡ªåŠ¨æ˜ å°„ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æ¥å£ã€‚

**æäº¤ ID**: ce11459  
**å®Œæˆæ—¥æœŸ**: 2025-01-15  
**æ€»è€—æ—¶**: ~2.5 å°æ—¶

---

## âœ… å®Œæˆçš„å·¥ä½œæ¸…å•

### 1ï¸âƒ£ æ•°æ®åº“ç»„ä»¶å¢å¼º 
**æ–‡ä»¶**: `alphahome/common/db_components/schema_management_mixin.py`

æ–°å¢3ä¸ªå…³é”®æ–¹æ³•ï¼š

```python
async def create_rawdata_view(view_name, source_schema, source_table, replace=False)
# æ”¯æŒè·¨ schema åˆ›å»ºè§†å›¾ï¼Œè‡ªåŠ¨æ·»åŠ  AUTO_MANAGED æ ‡è®°

async def check_table_exists(schema, table_name) -> bool
# é«˜æ•ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

async def get_tables_in_schema(schema) -> List[str]
# è·å– schema ä¸­çš„æ‰€æœ‰è¡¨
```

**ç‰¹ç‚¹**:
- âœ… è·¨ schema æ”¯æŒ
- âœ… è‡ªåŠ¨ COMMENT æ ‡è®°
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… å¼‚æ­¥å®ç°

### 2ï¸âƒ£ BaseTask è‡ªåŠ¨åŒ–é›†æˆ
**æ–‡ä»¶**: `alphahome/common/task_system/base_task.py`

**ä¿®æ”¹ `_ensure_table_exists()` æ–¹æ³•**ï¼š
- è¡¨åˆ›å»ºåè‡ªåŠ¨è°ƒç”¨è§†å›¾åˆ›å»º
- ä¿æŒç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘

**æ–°å¢ `_create_rawdata_view_if_needed()` æ–¹æ³•**ï¼š
```python
# ä¼˜å…ˆçº§1: tushare - æ€»æ˜¯ OR REPLACE
if data_source == 'tushare':
    await create_rawdata_view(..., replace=True)

# ä¼˜å…ˆçº§2+: akshare/å…¶ä»– - ä¼˜å…ˆçº§ä¿æŠ¤
else:
    # åŒé‡æ£€æŸ¥ï¼štushare å­˜åœ¨æ€§ + rawdata è§†å›¾å­˜åœ¨æ€§
    if not tushare_exists and not view_exists:
        await create_rawdata_view(..., replace=False)
```

**ç‰¹ç‚¹**:
- âœ… tushare ä¼˜å…ˆçº§è¦†ç›–
- âœ… ä¼˜å…ˆçº§ä¿æŠ¤ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
- âœ… å¤±è´¥ä¸ä¸­æ–­æ•°æ®é‡‡é›†

### 3ï¸âƒ£ ç³»ç»Ÿåˆå§‹åŒ–
**æ–‡ä»¶**: `alphahome/common/db_components/db_manager_core.py`

æ–°å¢ `_initialize_rawdata_schema()` æ–¹æ³•ï¼š
- åœ¨æ•°æ®åº“è¿æ¥æ—¶è‡ªåŠ¨è°ƒç”¨
- åˆ›å»º rawdata schema
- æ·»åŠ  schema æ–‡æ¡£è¯´æ˜
- å¤±è´¥ä¸ä¸­æ–­è¿æ¥

### 4ï¸âƒ£ æ‰¹é‡è¿ç§»è„šæœ¬
**æ–‡ä»¶**: `scripts/migrate_existing_tables_to_rawdata.py`

åŠŸèƒ½ï¼š
- æ‰«ææ‰€æœ‰æ•°æ®æº schemaï¼ˆtushare, akshare, ifind, pytdxï¼‰
- æŒ‰ä¼˜å…ˆçº§ä¸ºç°æœ‰è¡¨åˆ›å»ºè§†å›¾
- ç”Ÿæˆè¯¦ç»†çš„è¿ç§»æŠ¥å‘Š
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ¢å¤

**ä½¿ç”¨**:
```bash
python scripts/migrate_existing_tables_to_rawdata.py
```

**è¾“å‡º**:
```
=======================================================================
è¿ç§»å®ŒæˆæŠ¥å‘Š
=======================================================================
âœ“ æˆåŠŸåˆ›å»ºè§†å›¾: 150 ä¸ª
- è·³è¿‡çš„è¡¨: 5 ä¸ª
âœ— å¤±è´¥: 0 ä¸ª
=======================================================================
```

### 5ï¸âƒ£ é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `tests/integration/test_rawdata_views.py`

å››ä¸ªæ ¸å¿ƒæµ‹è¯•åœºæ™¯ï¼š

```python
âœ“ test_tushare_priority_coverage()
  - éªŒè¯ tushare åˆ›å»ºè¡¨æ—¶è‡ªåŠ¨è¦†ç›– rawdata è§†å›¾

âœ“ test_cascade_delete()
  - éªŒè¯åˆ é™¤æºè¡¨æ—¶ï¼Œrawdata è§†å›¾è‡ªåŠ¨è¢«åˆ é™¤

âœ“ test_priority_protection()
  - éªŒè¯ tushare å­˜åœ¨æ—¶ï¼Œå…¶ä»–æºä¸ä¼šåˆ›å»ºè§†å›¾

âœ“ test_comment_marking()
  - éªŒè¯è‡ªåŠ¨è§†å›¾éƒ½æœ‰ AUTO_MANAGED æ ‡è®°
```

**è¿è¡Œ**:
```bash
pytest tests/integration/test_rawdata_views.py -v
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡äº®ç‚¹

### 1. æ™ºèƒ½ä¼˜å…ˆçº§ç®¡ç†
```
tushare (ä¼˜å…ˆçº§1)
  â†“ è‡ªåŠ¨ OR REPLACE è§†å›¾
  â†“
akshare (ä¼˜å…ˆçº§2)
  â†“ ä»…å½“ tushare ä¸å­˜åœ¨æ—¶åˆ›å»º
  â†“
å…¶ä»–æ•°æ®æº (ä¼˜å…ˆçº§3+)
  â†“ æœ€ä½ä¼˜å…ˆçº§
```

### 2. PostgreSQL åŸç”Ÿä¾èµ–ç®¡ç†
- åˆ©ç”¨ `pg_depend` è‡ªåŠ¨è¿½è¸ªè§†å›¾å¯¹è¡¨çš„ä¾èµ–
- `DROP TABLE ... CASCADE` è‡ªåŠ¨åˆ é™¤ä¾èµ–è§†å›¾
- **æ— éœ€é¢å¤–ä»£ç å®ç°ä¾èµ–è¿½è¸ª**

### 3. éš”ç¦»ä¸å®‰å…¨
- æ¯ä¸ªè‡ªåŠ¨è§†å›¾éƒ½æ ‡è®°ï¼š`AUTO_MANAGED: source={schema}.{table}`
- rawdata schema ä»…åŒ…å«è‡ªåŠ¨è§†å›¾
- ç®¡ç†å·¥å…·å¯ä»¥è¯†åˆ«å’Œæ“ä½œè‡ªåŠ¨è§†å›¾

### 4. é›¶å½±å“é›†æˆ
- æ–°è¡¨åˆ›å»ºæ—¶è‡ªåŠ¨å¤„ç†
- ç°æœ‰ç³»ç»Ÿæ— éœ€ä¿®æ”¹
- å¤±è´¥ä¸ä¸­æ–­æ•°æ®é‡‡é›†
- å®Œå…¨å¼‚æ­¥ï¼Œéé˜»å¡

---

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ–°å¢ä»£ç è¡Œæ•° | ~250 è¡Œ |
| æ–°å¢æ–¹æ³• | 5 ä¸ª |
| æµ‹è¯•è¦†ç›– | 4 ä¸ªåœºæ™¯ |
| ä»£ç è´¨é‡ | 0 ä¸ª linter é”™è¯¯ |
| æ€§èƒ½å¼€é”€ | æå°ï¼ˆä»…è¡¨åˆ›å»ºæ—¶ï¼‰ |
| å®æ–½å¤æ‚åº¦ | ä½ï¼ˆè®¾è®¡ç®€æ´ï¼‰ |

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè‡ªåŠ¨åˆ›å»ºè§†å›¾
```python
# å½“ä»»ä½• FetcherTask åˆ›å»ºè¡¨æ—¶
class TushareStockBasicTask(FetcherTask):
    data_source = 'tushare'
    table_name = 'stock_basic'
    
    # è‡ªåŠ¨åˆ›å»º rawdata.stock_basic è§†å›¾ âœ“
```

### ç¤ºä¾‹2ï¼šç»Ÿä¸€æŸ¥è¯¢æ¥å£
```sql
-- æ‰€æœ‰æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨ rawdata schema
SELECT * FROM rawdata.stock_basic;      -- tushare ä¼˜å…ˆ
SELECT * FROM rawdata.fund_basic;        -- akshareï¼ˆå¦‚æœ tushare ä¸å­˜åœ¨ï¼‰
SELECT * FROM rawdata.daily_basic;       -- è‡ªåŠ¨æŒ‡å‘æœ‰æ•°æ®çš„æº

-- ä¸éœ€è¦è®°ä½æ•°æ®æºåœ¨å“ªä¸ª schema
```

### ç¤ºä¾‹3ï¼šåˆ é™¤å¤„ç†
```sql
-- åˆ é™¤è¡¨æ—¶å¿…é¡»ä½¿ç”¨ CASCADE
DROP TABLE tushare.stock_basic CASCADE;

-- PostgreSQL è‡ªåŠ¨å¤„ç†ï¼š
-- 1. åˆ é™¤ tushare.stock_basic è¡¨
-- 2. è‡ªåŠ¨åˆ é™¤ rawdata.stock_basic è§†å›¾
-- 3. æ‰€æœ‰ä¾èµ–éƒ½è¢«æ¸…ç†
```

### ç¤ºä¾‹4ï¼šè¿ç§»ç°æœ‰æ•°æ®
```bash
# ä¸ºç°æœ‰è¡¨æ‰¹é‡åˆ›å»ºè§†å›¾
python scripts/migrate_existing_tables_to_rawdata.py

# è¾“å‡ºè¯¦ç»†æŠ¥å‘Šï¼Œæ˜¾ç¤ºå¤„ç†ç»“æœ
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### éªŒè¯1ï¼šè§†å›¾å­˜åœ¨
```sql
SELECT table_name FROM information_schema.views 
WHERE table_schema = 'rawdata' 
LIMIT 5;
```

### éªŒè¯2ï¼šè§†å›¾æ˜ å°„æº
```sql
SELECT pg_get_viewdef('rawdata.stock_basic'::regclass);
-- è¾“å‡ºï¼šSELECT * FROM tushare."stock_basic"
```

### éªŒè¯3ï¼šè§†å›¾æ ‡è®°
```sql
SELECT obj_description(
  (quote_ident('rawdata') || '.' || quote_ident('stock_basic'))::regclass
) as comment;
-- è¾“å‡ºï¼šAUTO_MANAGED: source=tushare.stock_basic
```

### éªŒè¯4ï¼šè¿è¡Œæµ‹è¯•
```bash
pytest tests/integration/test_rawdata_views.py -v
# æ‰€æœ‰æµ‹è¯•åº”è¯¥é€šè¿‡
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. DELETE å¿…é¡»ä½¿ç”¨ CASCADE
```sql
# âœ“ æ­£ç¡®
DROP TABLE tushare.stock_basic CASCADE;

# âœ— é”™è¯¯
DROP TABLE tushare.stock_basic;
# ä¼šæŠ¥é”™ï¼šcannot drop table because other objects depend on it
```

### 2. rawdata éš”ç¦»åŸåˆ™
- âœ… rawdata ä»…åŒ…å«è‡ªåŠ¨è§†å›¾
- âœ— ç¦æ­¢åœ¨ rawdata ä¸­æ‰‹åŠ¨åˆ›å»ºè¡¨æˆ–è§†å›¾
- âœ… æ‰€æœ‰è‡ªåŠ¨è§†å›¾éƒ½æœ‰ AUTO_MANAGED æ ‡è®°

### 3. æ•°æ®æºä¼˜å…ˆçº§ä¸å¯é€†è½¬
- ä¸€æ—¦ tushare è¡¨å­˜åœ¨ï¼Œå…¶ä»–æºåˆ›å»ºçš„è§†å›¾ä¼šè¢«ä¿æŠ¤
- è¦åˆ‡æ¢æ•°æ®æºï¼Œéœ€è¦åˆ é™¤å½“å‰çš„ã€åˆ›å»ºæ–°çš„

### 4. å¹¶å‘å®‰å…¨
- å®ç°äº†åŒé‡æ£€æŸ¥æœºåˆ¶
- æ”¯æŒå¤šä¸ªæ•°æ®æºå¹¶å‘åˆ›å»ºè¡¨
- æ— ç«æ€æ¡ä»¶

---

## ğŸ“ˆ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- [ ] ç›‘æ§å·¥å…·ï¼šæ£€æµ‹ rawdata å¯¹è±¡å˜æ›´
- [ ] è¯Šæ–­å·¥å…·ï¼šæ£€æµ‹å­¤å„¿è§†å›¾
- [ ] è‡ªåŠ¨ä¿®å¤ï¼šæ¸…ç†æ— æ•ˆè§†å›¾

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
- [ ] ç‰©åŒ–è§†å›¾æ”¯æŒï¼šä¼˜åŒ–é«˜é¢‘æŸ¥è¯¢
- [ ] æ€§èƒ½ç›‘æ§ï¼šè¿½è¸ªè§†å›¾æŸ¥è¯¢æ€§èƒ½
- [ ] æ•°æ®æºåˆ‡æ¢å·¥å…·ï¼šç®€åŒ–æ•°æ®æºå˜æ›´

### é•¿æœŸï¼ˆ2-3ä¸ªæœˆï¼‰
- [ ] PostgreSQL DDL triggerï¼šæ›´é«˜çº§çš„è‡ªåŠ¨åŒ–
- [ ] å¤šæ•°æ®åº“æ”¯æŒï¼šé€‚é…å…¶ä»–æ•°æ®åº“
- [ ] æ•°æ®åŒæ­¥æœºåˆ¶ï¼šæ”¯æŒå¤šæºæ•°æ®èšåˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `RAWDATA_SCHEMA_IMPLEMENTATION.md` - è¯¦ç»†å®æ–½æ–‡æ¡£
- `tests/integration/test_rawdata_views.py` - é›†æˆæµ‹è¯•ä»£ç 
- `scripts/migrate_existing_tables_to_rawdata.py` - è¿ç§»è„šæœ¬
- `.cursor/plans/rawdata_schema_è‡ªåŠ¨è§†å›¾æ˜ å°„_5e59a921.plan.md` - åŸå§‹è®¡åˆ’

---

## âœ¨ é¡¹ç›®äº®ç‚¹

1. **å®Œå…¨è‡ªåŠ¨åŒ–** - å¼€å‘è€…æ— éœ€å¹²é¢„ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†
2. **é›¶å­˜å‚¨æˆæœ¬** - è§†å›¾ä¸å ç”¨é¢å¤–å­˜å‚¨ç©ºé—´
3. **æ€§èƒ½ä¼˜è¶Š** - è§†å›¾æŸ¥è¯¢æ€§èƒ½ç­‰åŒäºç›´æ¥æŸ¥è¯¢
4. **é«˜å¯é æ€§** - å¤šå±‚é”™è¯¯å¤„ç†ï¼Œä¸ä¸­æ–­æœåŠ¡
5. **æ˜“äºç»´æŠ¤** - è®¾è®¡ç®€æ´ï¼Œä½¿ç”¨ PostgreSQL åŸç”Ÿæœºåˆ¶
6. **å……åˆ†æµ‹è¯•** - è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåœºæ™¯

---

## ğŸ‰ æ€»ç»“

rawdata schema è‡ªåŠ¨è§†å›¾æ˜ å°„ç³»ç»Ÿå·²å®Œæ•´å®æ–½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°
- âœ… ç³»ç»Ÿé›†æˆ
- âœ… æ‰¹é‡è¿ç§»å·¥å…·
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–
- âœ… è¯¦ç»†æ–‡æ¡£

ç³»ç»Ÿç°å·²æŠ•å…¥ä½¿ç”¨ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æ¥å£ï¼Œå¤§å¤§é™ä½äº†æ•°æ®æºç®¡ç†çš„å¤æ‚æ€§ã€‚

---

**æäº¤ ID**: ce11459  
**å®Œæˆæ—¥æœŸ**: 2025-01-15  
**ä½œè€…**: AI Assistant  
**çŠ¶æ€**: âœ… å®Œæˆ
