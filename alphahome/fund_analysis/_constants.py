"""
口径定义文件 - 基金分析模块的核心常量和约定

本文件定义了基金分析模块的所有默认参数、计算口径和处理规则。
这些常量是模块的"契约"，确保计算结果的一致性和可复现性。

重要说明：
- 修改这些常量会影响所有分析结果
- 生产环境中应谨慎修改
- 如需自定义，建议通过参数传入而非修改常量
"""

from enum import Enum
from typing import Final

# =============================================================================
# 年化因子
# =============================================================================

# 默认年化因子（交易日数）
# 说明：中国A股市场一年约 250 个交易日
# 注意：禁止在代码中硬编码 252/250，统一使用此常量
DEFAULT_PERIODS_PER_YEAR: Final[int] = 250

# 不同频率的年化因子
PERIODS_PER_YEAR_DAILY: Final[int] = 250  # 日频
PERIODS_PER_YEAR_WEEKLY: Final[int] = 52   # 周频
PERIODS_PER_YEAR_MONTHLY: Final[int] = 12  # 月频

# =============================================================================
# 无风险利率
# =============================================================================

# 默认无风险利率（年化）
# 说明：用于计算 Sharpe/Sortino 等风险调整收益指标
# 默认为 0.0，可通过参数配置
DEFAULT_RISK_FREE_RATE: Final[float] = 0.0

# =============================================================================
# 基准对齐规则
# =============================================================================

# 前值填充最大容忍缺口（交易日数）
# 说明：对齐组合与基准时，基准净值缺失时使用前值填充
# 超过此限制的缺口将保留 NaN，相对指标返回 NaN 并记录 warning
FFILL_LIMIT: Final[int] = 5

# =============================================================================
# 空值处理策略
# =============================================================================

class NullStrategy(Enum):
    """空值处理策略枚举"""
    
    # 返回 NaN（默认策略）
    RETURN_NAN = "return_nan"
    
    # 返回 0
    RETURN_ZERO = "return_zero"
    
    # 抛出异常
    RAISE_ERROR = "raise_error"
    
    # 跳过计算
    SKIP = "skip"


# 默认空值策略
DEFAULT_NULL_STRATEGY: Final[NullStrategy] = NullStrategy.RETURN_NAN

# =============================================================================
# 边缘情况处理规则
# =============================================================================

# 最小样本数要求
# 说明：样本数小于此值时，统计指标返回 NaN
MIN_SAMPLE_SIZE: Final[int] = 2

# 标准差为零时的处理
# 说明：当波动率为 0 时，Sharpe 等比率指标返回 NaN（而非 0 或 inf）
ZERO_STD_RETURNS_NAN: Final[bool] = True

# 无亏损样本时盈亏比的返回值
# 说明：当没有亏损样本时，盈亏比返回正无穷
PROFIT_LOSS_RATIO_NO_LOSS: Final[float] = float('inf')

# =============================================================================
# VaR/CVaR 默认参数
# =============================================================================

# 默认置信水平
DEFAULT_VAR_CONFIDENCE: Final[float] = 0.95

# 支持的置信水平列表
SUPPORTED_VAR_CONFIDENCE_LEVELS: Final[tuple] = (0.90, 0.95, 0.99)

# =============================================================================
# 回撤分析默认参数
# =============================================================================

# 默认返回的最大回撤周期数
DEFAULT_TOP_N_DRAWDOWNS: Final[int] = 5

# =============================================================================
# 滚动计算默认窗口
# =============================================================================

# 滚动收益/夏普默认窗口（交易日）
DEFAULT_ROLLING_RETURN_WINDOW: Final[int] = 252  # 约一年

# 滚动波动率默认窗口（交易日）
DEFAULT_ROLLING_VOLATILITY_WINDOW: Final[int] = 60  # 约三个月

# =============================================================================
# 集中度分析默认参数
# =============================================================================

# Top N 集中度的默认 N 值
DEFAULT_TOP_N_CONCENTRATION: Final[int] = 5

# =============================================================================
# 交易记录口径定义
# =============================================================================

class TransactionSide(Enum):
    """交易方向枚举
    
    说明：
    - BUY (1): 买入/申购
    - SELL (-1): 卖出/赎回
    - FEE (0): 管理费等费用，换手率计算时排除
    
    使用示例：
        # 筛选有效交易（排除管理费）
        valid_trades = df[df['side'] != TransactionSide.FEE.value]
        
        # 筛选买入交易
        buys = df[df['side'] == TransactionSide.BUY.value]
    """
    BUY = 1
    SELL = -1
    FEE = 0  # 管理费，排除在换手率计算外


# =============================================================================
# 交易记录字段规范
# =============================================================================

# 日期字段名
# 说明：换手率计算使用结算日期（settle_date）而非交易日期（trade_date）
# 原因：结算日期更准确反映资金实际流动时点
TRANSACTION_DATE_FIELD: Final[str] = "settle_date"

# 交易方向字段名
TRANSACTION_SIDE_FIELD: Final[str] = "side"

# 交易金额字段名
# 说明：交易金额，不含费用（申购费/赎回费单独记录）
TRANSACTION_AMOUNT_FIELD: Final[str] = "amount"

# 交易份额字段名
TRANSACTION_UNITS_FIELD: Final[str] = "units"

# 交易费用字段名
TRANSACTION_FEE_FIELD: Final[str] = "fee"

# 基金代码字段名
TRANSACTION_FUND_ID_FIELD: Final[str] = "fund_id"


# =============================================================================
# 交易记录 DataFrame 规范
# =============================================================================

# 交易记录必需列
TRANSACTION_REQUIRED_COLUMNS: Final[tuple] = (
    TRANSACTION_DATE_FIELD,    # settle_date: 结算日期
    TRANSACTION_FUND_ID_FIELD, # fund_id: 基金代码
    TRANSACTION_SIDE_FIELD,    # side: 交易方向 (1=买入, -1=卖出, 0=管理费)
    TRANSACTION_AMOUNT_FIELD,  # amount: 交易金额（不含费用）
)

# 交易记录可选列
TRANSACTION_OPTIONAL_COLUMNS: Final[tuple] = (
    TRANSACTION_UNITS_FIELD,   # units: 交易份额
    TRANSACTION_FEE_FIELD,     # fee: 交易费用
)

# 交易记录完整列（必需 + 可选）
TRANSACTION_ALL_COLUMNS: Final[tuple] = (
    TRANSACTION_REQUIRED_COLUMNS + TRANSACTION_OPTIONAL_COLUMNS
)


# =============================================================================
# 换手率计算口径
# =============================================================================

# 换手率计算公式：
# turnover_rate = (Σ|buy_amount| + Σ|sell_amount|) / (2 * avg_aum)
#
# 说明：
# 1. 使用 settle_date 作为日期字段
# 2. 排除 side=0 的管理费记录
# 3. amount 为交易金额，不含费用
# 4. avg_aum 为计算周期内的平均资产规模
# 5. 输出为年化换手率

# 换手率计算时排除的交易类型
TURNOVER_EXCLUDED_SIDES: Final[tuple] = (TransactionSide.FEE.value,)  # 排除管理费

# =============================================================================
# 日志级别约定
# =============================================================================

# 边缘情况使用 DEBUG 级别
# 数据质量问题使用 WARNING 级别
# 错误信息包含具体参数值和建议操作
